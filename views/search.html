<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <link rel="stylesheet" href="/search.css">
    <title>Selled Products</title>
</head>

<body>

    <nav id="navbar" class="navbar navbar-dark navbar-expand-md bg-dark text-light mb-2">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">New Bill</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse justify-content-evenly" id="navbarNav">
                <ul class="navbar-nav d-flex w-100">
                    <li class="nav-item ms-2 mt-1">
                        <a href="/all"><button class="btn btn-primary" id="btn-func">All bills</button></a>
                    </li>

                    <li class="nav-item ms-2 mt-1 border-bottom border-3 rounded-bottom border-info">
                        <a href="/search"><button class="btn btn-info" id="btn-func"><strong>Search
                                    User</strong></button></a>
                    </li>

                    <li class="nav-item ms-auto">
                        <a class="nav-link" href="/logout"><button class="btn btn-outline-info ms-1"> Log
                                out</button></a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>


    <div class="row row-cols-2" id="row">
        <div class="col-3" id="search">
            <div class="ms-3 text-center border-bottom border-5">
                <h1 class="mt-1">Enter employers name</h1>
                <form class="text-center" action="/search" method="post">
                    <div class="form-group mt-3 w-50 ms-auto me-auto">
                        <label for="user"></label>
                        <input type="text" class="form-control w-100 border-2 border-dark" name="username" id="user"
                            placeholder="John Wick" required>
                    </div>
                    <div class="footer mb-4">
                        <button class="btn btn-sm btn-primary mt-3 ms-2">Submit</button>
                    </div>
                </form>
            </div>
            <% if(usersData.length) {%>
                <div class="mt-4">
                    <div class="btns mt-4 p-1 d-flex  justify-content-evenly">
                        <button class="btn btn-primary" onclick="allBills()">All</button>
                        <button class="btn btn-danger" onclick="notPayed()">Not Payed</button>
                        <button class="btn btn-success" onclick="window.print()">Print</button>
                    </div>
                </div>
                <% } %>
        </div>

        <div class="col-9" id="result">
            <h1 class="mb-2 text-center" id="h1Results">Results</h1>
            <div id="allBills">
                <div class="head">
                    <% if(usersData.length) {%>
                        <% if(searched) {%>
                            <h1 id="searched"><strong>
                                    <%= searched %> all bills.
                                </strong></h1>
                            <% } %>
                                <% } %>
                </div>
                <% if(!usersData.length){ %>
                    <h2 class="text-center mt-3">Nothing to show here.</h2>
                    <%- include('../flashError') %>
                        <% }else{ %>
                            <% for (data of usersData) {%>
                                <div id="data">
                                    <table id="table" class="table table-dark table-hover mt-3 text-center">
                                        <thead id="table-data">
                                            <th class="col">Product</th>
                                            <th class="col">Qty</th>
                                            <th class="col">Total</th>
                                            <th class="col">Month</th>
                                            <th class="col">Week</th>
                                            <th class="col">Free</th>
                                            <th class="col">Payed</th>
                                            <th class="col">Sold date</th>
                                            <th class="col">Sold by</th>
                                        </thead>
                                        <tbody>
                                            <% for (names of data) {%>
                                                <% for(product of names.products) {%>
                                                    <tr>
                                                        <td>
                                                            <%= product.name %>
                                                        </td>
                                                        </td>
                                                        <td>
                                                            <%= product.qty %>
                                                        </td>
                                                        </td>
                                                        <td>
                                                            <%= product.total %>
                                                        </td>
                                                        <td>
                                                            <%= names.month %>
                                                        </td>
                                                        <td>
                                                            <%= names.kt %>
                                                        </td>
                                                        <td>

                                                            <% if(product.firstOfWeek=='true' ){ %>
                                                                <img src="../payed.jpg" alt="Free">
                                                                <% } else { %>
                                                                    <img src="../notPay.jpg" alt="Not Free">
                                                                    <% } %>
                                                        </td>

                                                        <td>

                                                            <% if(names.pay=='true' ){ %>
                                                                <img src="../payed.jpg" alt="Payed">
                                                                <% } else { %>
                                                                    <img src="../notPay.jpg" alt="Not Payed">
                                                                    <% } %>
                                                        </td>
                                                        <td>
                                                            <%= names.soldDate %>
                                                        </td>
                                                        <td>
                                                            <%= names.izdal %>
                                                        </td>
                                                    </tr>
                                                    <% }%>
                                                        <% }%>
                                        </tbody>
                                    </table>
                                </div>

                                <% } %>
                                    <% } %>
            </div>

            <!-- UNPAYED BILLS-->
            <div id="unPayedBills">
                <div class="mt-4">
                    <h1 id="unPayedH1">Unpayed bills</h1>
                </div>
                <% for(data of usersData) {%>
                    <table id="notPayedTable" class="table table-dark table-hover mt-3 text-center">
                        <thead id="table-data">
                            <th class="col">Product</th>
                            <th class="col">Qty</th>
                            <th class="col">Total</th>
                            <th class="col">Month</th>
                            <th class="col">Week</th>
                            <th class="col">Payed</th>
                            <th class="col">Sold date</th>
                            <th class="col">Sold by</th>
                        </thead>
                        <tbody>
                            <% for(user of data) {%>
                                <% if(user.pay=="false" ) {%>
                                    <% for(products of user.products) {%>
                                        <tr>
                                            <td>
                                                <%= products.name %>
                                            </td>
                                            <td>
                                                <%= products.qty %>
                                            </td>
                                            <td>
                                                <%= products.total %>
                                            </td>
                                            <td>
                                                <%= user.month %>
                                            </td>
                                            <td>
                                                <%= user.kt %>
                                            </td>
                                            <td>
                                                <img src="../notPay.jpg" alt="Not Payed">
                                            </td>
                                            <td>
                                                <%= user.soldDate %>
                                            </td>
                                            <td>
                                                <%= user.izdal %>
                                            </td>
                                        </tr>
                                        <% } %>
                                            <% } %>
                                                <% } %>
                                                    <tr class="bg-danger">
                                                        <td>Skupaj</td>
                                                        <td id="qtys"></td>
                                                        <td id="payed" class="bg-danger"></td>
                                                        <td></td>
                                                        <td></td>
                                                        <td></td>
                                                        <td></td>
                                                        <td></td>
                                                    </tr>
                        </tbody>
                    </table>
                    <% } %>
            </div>


        </div>

    </div>
    <script>
        document.getElementById("unPayedBills").style.display = "none";
        document.getElementById("allBills").style.display = "block";
        function notPayed() {
            document.getElementById("allBills").style.display = "none";
            document.getElementById("unPayedBills").style.display = "block";
        }
        function allBills() {
            document.getElementById("allBills").style.display = "block";
            document.getElementById("unPayedBills").style.display = "none";
        }

        let taable = document.getElementById('notPayedTable');
        let rows = taable.rows.length - 2
        let pay = 0;
        let qtys = 0;
        for (let i = 1; i <= rows; i++) {
            //console.log(rows[i].cells[5].innerHTML)
            // var x = document.getElementById('myTable').rows[i].cells[5].children[0].value;
            var x = document.getElementById('notPayedTable').rows[i].cells[2].innerHTML
            var y = document.getElementById('notPayedTable').rows[i].cells[1].innerHTML
            pay += parseFloat(x, 10);
            qtys += parseFloat(y, 10);

        }
        document.getElementById('payed').innerHTML = pay.toFixed(2) + ' ' + '€';
        document.getElementById('qtys').innerHTML = qtys;
    </script>

    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.10.2/dist/umd/popper.min.js"
        integrity="sha384-7+zCNj/IqJ95wo16oMtfsKbZ9ccEh31eOz1HGyDuCQ6wgnyJNSYdrPa03rtR1zdB"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js"
        integrity="sha384-QJHtvGhmr9XOIpI6YVutG+2QOK9T+ZnN4kzFN1RtK3zEFEIsxhlmWl5/YESvpZ13"
        crossorigin="anonymous"></script>
</body>

</html>